<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>¬°Se te Antoja! üòã</title>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.8);
            --ios-blue: #007AFF;
            --ios-orange: #FF9500;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --primary: #FF8C00;
            --dark: #1C1C1E;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            background-color: var(--ios-bg); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            color: var(--dark);
        }
        
        /* HEADER ESTILO IOS */
        header { 
            background: rgba(255, 140, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white; 
            display: grid; 
            grid-template-columns: 80px 1fr 80px; 
            align-items: center; 
            height: 70px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }
        .logo { grid-column: 2; font-size: 1.6rem; font-weight: 700; text-align: center; letter-spacing: -0.5px; }
        .menu-btn { 
            grid-column: 3; 
            justify-self: end; 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: none; 
            padding: 8px 14px; 
            border-radius: 18px; 
            font-weight: 600; 
            margin-right: 15px;
            font-size: 0.9rem;
        }

        .main-container { display: flex; flex: 1; height: calc(100% - 70px); }
        
        /* AREA PRODUCTOS */
        .products-area { 
            flex: 2; 
            padding: 15px; 
            overflow-y: auto; 
            background: var(--ios-bg); 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            grid-auto-rows: 220px; 
            gap: 15px; 
        }
        
        .product-card { 
            background: white; 
            border-radius: 22px; 
            padding: 12px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            border: 3px solid transparent; /* Reservado para alerta */
        }
        
        /* ALERTA DE INVENTARIO */
        .out-of-stock { 
            border-color: var(--ios-red) !important;
            opacity: 0.8;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }

        .product-card:active { transform: scale(0.96); background: #F2F2F7; }
        .product-card img { width: 100%; height: 130px; object-fit: cover; border-radius: 14px; margin-bottom: 8px; }
        .prod-name { font-weight: 600; font-size: 1rem; letter-spacing: -0.3px; color: #000; }
        .prod-price { color: var(--ios-orange); font-weight: 700; font-size: 1.1rem; margin-top: auto; }

        /* CARRITO ESTILO IOS */
        .cart-area { 
            flex: 1; 
            background: white; 
            border-left: 0.5px solid #D1D1D6; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            min-width: 350px; 
        }
        .cart-area h3 { font-size: 1.4rem; font-weight: 800; margin-top: 0; }
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 0.5px solid #E5E5EA; 
            font-weight: 500;
        }
        
        .totals-area { 
            background: #F2F2F7; 
            padding: 20px; 
            border-radius: 24px; 
            margin-top: 15px;
        }
        .total-row { display: flex; justify-content: space-between; font-size: 1.6rem; font-weight: 800; margin-bottom: 15px; }
        
        .payment-input { 
            width: 100%; 
            padding: 16px; 
            font-size: 1.4rem; 
            border: none; 
            border-radius: 14px; 
            background: white; 
            text-align: center;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .action-btn { 
            width: 100%; 
            padding: 18px; 
            border: none; 
            border-radius: 16px; 
            color: white; 
            font-size: 1.1rem; 
            font-weight: 700; 
            margin-bottom: 10px; 
            transition: opacity 0.2s;
        }
        .btn-pay { background: var(--ios-green); box-shadow: 0 4px 14px rgba(52, 199, 89, 0.3); opacity: 0.4; pointer-events: none;}
        .btn-pay.active { opacity: 1; pointer-events: auto; }
        .btn-credit { background: var(--ios-blue); box-shadow: 0 4px 14px rgba(0, 122, 255, 0.3); }

        /* MODALES IOS */
        .modal { display: none; position: fixed; inset: 0; background: var(--ios-bg); z-index: 100; flex-direction: column; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: 800; 
            font-size: 1.2rem;
            background: white;
            border-bottom: 0.5px solid #D1D1D6;
        }

        /* TABLAS Y FORMULARIOS */
        input, select { -webkit-appearance: none; border: 0.5px solid #D1D1D6; border-radius: 10px; padding: 12px; }
        .qty-btn { width: 38px; height: 38px; border-radius: 12px; border: none; font-size: 1.4rem; font-weight: 600; color: white; }

        .chart-container { 
            height: 250px; 
            background: white; 
            border-radius: 20px; 
            padding: 20px; 
            display: flex; 
            align-items: flex-end; 
            justify-content: space-around;
            box-shadow: inset 0 -2px 10px rgba(0,0,0,0.05);
        }
        .bar { width: 25px; border-radius: 6px; transition: height 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
    </style>
</head>
<body>

<header>
    <div></div>
    <div class="logo">¬°Se te Antoja! üòã</div>
    <button class="menu-btn" onclick="openMenu()">Men√∫</button>
</header>

<div class="main-container">
    <div class="products-area" id="productsGrid"></div>
    <div class="cart-area">
        <h3>Tu Pedido</h3>
        <div class="cart-list" id="cartList"></div>
        <div class="totals-area">
            <div class="total-row"><span>Total</span><span id="totalAmount">Q0.00</span></div>
            <input type="number" id="payInput" class="payment-input" placeholder="¬øCon cu√°nto paga?" oninput="calcChange()">
            <div id="changeDisplay" style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--ios-blue)">Cambio: Q0.00</div>
            <button id="btnPay" class="action-btn btn-pay" onclick="processPayment('cash')">Cobrar üíµ</button>
            <button class="action-btn btn-credit" onclick="processPayment('credit')">Anotar Fiado üìù</button>
        </div>
    </div>
</div>

<div id="modalMenu" class="modal">
    <div class="modal-header"><span>Configuraci√≥n</span><button class="menu-btn" style="background:var(--ios-red)" onclick="closeModal('modalMenu')">Cerrar</button></div>
    <div class="menu-grid" style="padding:20px; gap:15px">
        <button class="menu-option" style="background:var(--ios-orange)" onclick="openSection('modalGastos')">Gastos</button>
        <button class="menu-option" style="background:var(--ios-blue)" onclick="openSection('modalFiado')">Fiados</button>
        <button class="menu-option" style="background:#5856D6" onclick="openSection('modalHistorial')">Historial</button>
        <button class="menu-option" style="background:var(--ios-green)" onclick="openSection('modalInventario')">Inventario</button>
    </div>
</div>

<div id="modalInventario" class="modal">
    <div class="modal-header"><span>Inventario</span><button class="menu-btn" onclick="closeModal('modalInventario')">Volver</button></div>
    <div class="modal-content" style="padding:20px; display:flex; flex-direction:column; gap:20px; overflow-y:auto">
        <div style="background:white; padding:15px; border-radius:20px">
            <h4>Materia Prima</h4>
            <input type="text" id="invName" placeholder="Nombre" style="width:100%; margin-bottom:10px">
            <input type="number" id="invQty" placeholder="Cant." style="width:100%; margin-bottom:10px">
            <button class="action-btn" style="background:var(--dark)" onclick="addInventoryItem()">Agregar Material</button>
            <table id="inventoryTable" style="width:100%; border-collapse:collapse; margin-top:15px"></table>
        </div>
        <div style="background:white; padding:15px; border-radius:20px">
            <h4 id="formTitle">Nuevo Producto</h4>
            <label style="background:var(--ios-bg); padding:10px; display:block; border-radius:12px; text-align:center; cursor:pointer" onclick="document.getElementById('prodImgInput').click()">üì∏ Elegir Foto</label>
            <input type="file" id="prodImgInput" accept="image/*" style="display:none" onchange="previewProdImg(this)">
            <img id="prodImgPreview" style="width:100px; height:100px; display:none; margin:10px auto; border-radius:15px; object-fit:cover">
            <input type="hidden" id="editProdId">
            <input type="text" id="prodName" placeholder="Nombre" style="width:100%; margin:10px 0">
            <input type="number" id="prodPrice" placeholder="Precio Q" style="width:100%; margin-bottom:10px">
            <div id="recipeChecklist" class="recipe-checklist"></div>
            <button id="btnSaveProd" class="action-btn" style="background:var(--ios-orange)" onclick="saveProduct()">Guardar en Men√∫</button>
            <table id="productsTable" style="width:100%; margin-top:15px"></table>
        </div>
    </div>
</div>

<div id="modalHistorial" class="modal">
    <div class="modal-header"><span>Historial</span><button class="menu-btn" onclick="closeModal('modalHistorial')">Volver</button></div>
    <div style="padding:20px; overflow-y:auto">
        <button class="menu-btn" style="background:var(--dark); position:static; width:100%; margin-bottom:10px" onclick="clearAllData()">‚ö†Ô∏è BORRAR TODO EL HISTORIAL</button>
        <div style="background:white; padding:20px; border-radius:20px; margin-bottom:20px">
            <h3 id="todayDateLabel"></h3>
            <div id="todayStats" style="font-size:1.2rem; font-weight:700"></div>
            <div id="salesHistoryList" style="margin-top:15px"></div>
        </div>
        <div class="chart-container" id="chartContainer"></div>
    </div>
</div>

<script>
    let DB = { products: [], inventory: [], sales: [], expenses: [], credits: [] };
    let cart = []; let currentImg = null; let chartMode = 'daily';

    const getLocalYMD = (d = new Date()) => {
        let off = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - off).toISOString().split('T')[0];
    };

    function loadData() {
        let saved = localStorage.getItem('antojableDB_v5');
        if (saved) DB = JSON.parse(saved);
        renderProducts();
    }
    function saveData() { localStorage.setItem('antojableDB_v5', JSON.stringify(DB)); }

    // --- FUNCI√ìN DE ALERTA DE INVENTARIO ---
    function checkProductStock(p) {
        if (!p.recipeIds || p.recipeIds.length === 0) return true;
        return p.recipeIds.every(rid => {
            let item = DB.inventory.find(inv => inv.id == rid);
            return item && item.qty > 0;
        });
    }

    function renderProducts() {
        const grid = document.getElementById('productsGrid'); grid.innerHTML = '';
        DB.products.forEach(p => {
            const hasStock = checkProductStock(p);
            const card = document.createElement('div'); 
            card.className = `product-card ${hasStock ? '' : 'out-of-stock'}`;
            
            card.innerHTML = `
                ${p.image ? `<img src="${p.image}">` : `<div style="height:130px; background:#E5E5EA; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:3rem">üçî</div>`}
                <div class="prod-name">${p.name}</div>
                <div class="prod-price">${hasStock ? 'Q' + p.price : '¬°SIN STOCK!'}</div>
            `;
            
            if(hasStock) {
                card.onclick = () => { cart.push({...p, cId: Date.now()}); renderCart(); };
            } else {
                card.onclick = () => alert("‚ö†Ô∏è No puedes vender este producto porque te faltan ingredientes en el inventario.");
            }
            grid.appendChild(card);
        });
    }

    // --- RESTO DE FUNCIONES (SISTEMA FULL) ---
    function renderCart() {
        const list = document.getElementById('cartList'); list.innerHTML = '';
        let total = 0;
        cart.forEach(i => {
            total += parseFloat(i.price);
            list.innerHTML += `<div class="cart-item"><span>${i.name}</span><span>Q${i.price} <button style="border:none; background:none; color:var(--ios-red); font-weight:700" onclick="removeItem(${i.cId})">Eliminar</button></span></div>`;
        });
        document.getElementById('totalAmount').innerText = `Q${total.toFixed(2)}`;
        calcChange();
    }
    function removeItem(id) { cart = cart.filter(i => i.cId !== id); renderCart(); }

    function calcChange() {
        let t = cart.reduce((s, i) => s + parseFloat(i.price), 0);
        let p = parseFloat(document.getElementById('payInput').value) || 0;
        let b = document.getElementById('btnPay');
        if (t > 0 && p >= t) { b.classList.add('active'); document.getElementById('changeDisplay').innerText = `Cambio: Q${(p-t).toFixed(2)}`; }
        else { b.classList.remove('active'); document.getElementById('changeDisplay').innerText = "Falta efectivo"; }
    }

    function processPayment(type) {
        let t = cart.reduce((s, i) => s + parseFloat(i.price), 0); if (t === 0) return;
        let now = new Date();
        if (type === 'credit') {
            let n = prompt("Nombre del Cliente:"); if (!n) return;
            DB.credits.push({ id: Date.now(), dIso: now.toISOString(), dYMD: getLocalYMD(now), name: n, t: t });
        } else {
            cart.forEach(p => { if (p.recipeIds) p.recipeIds.forEach(rid => { let inv = DB.inventory.find(iv => iv.id == rid); if (inv) inv.qty--; })});
            DB.sales.push({ id: Date.now(), dIso: now.toISOString(), dYMD: getLocalYMD(now), t: t });
        }
        saveData(); cart = []; document.getElementById('payInput').value = ''; renderCart(); renderProducts(); alert("¬°Venta Exitosa!");
    }

    function addInventoryItem() {
        let n = document.getElementById('invName').value; let q = parseInt(document.getElementById('invQty').value) || 0;
        if (!n) return; DB.inventory.push({ id: Date.now(), name: n, qty: q });
        saveData(); renderInventoryTable(); updateRecipeChecklist(); renderProducts();
    }
    function renderInventoryTable() {
        const tb = document.getElementById('inventoryTable'); tb.innerHTML = '';
        DB.inventory.forEach(i => {
            tb.innerHTML += `<tr style="border-bottom:0.5px solid #eee">
                <td style="padding:10px 0">${i.name}</td>
                <td><button class="qty-btn" style="background:var(--ios-red)" onclick="adjInv(${i.id},-1)">-</button>
                    <span style="font-weight:700; margin:0 10px">${i.qty}</span>
                    <button class="qty-btn" style="background:var(--ios-green)" onclick="adjInv(${i.id},1)">+</button></td>
                <td><button onclick="delInv(${i.id})" style="border:none; background:none">üóëÔ∏è</button></td></tr>`;
        });
    }
    function adjInv(id, n) { let i = DB.inventory.find(x => x.id == id); if (i) { i.qty += n; if (i.qty < 0) i.qty = 0; saveData(); renderInventoryTable(); renderProducts(); } }
    function delInv(id) { if(confirm("¬øBorrar?")) { DB.inventory = DB.inventory.filter(i => i.id !== id); saveData(); renderInventoryTable(); renderProducts(); } }

    function previewProdImg(f) {
        let r = new FileReader(); r.onload = e => { currentImg = e.target.result; document.getElementById('prodImgPreview').src = currentImg; document.getElementById('prodImgPreview').style.display='block'; };
        r.readAsDataURL(f.files[0]);
    }
    function saveProduct() {
        let n = document.getElementById('prodName').value; let p = parseFloat(document.getElementById('prodPrice').value);
        let rIds = Array.from(document.querySelectorAll('#recipeChecklist input:checked')).map(c => parseInt(c.value));
        if (!n || !p) return;
        let editId = document.getElementById('editProdId').value;
        if (editId) {
            let idx = DB.products.findIndex(x => x.id == editId);
            DB.products[idx] = { id: parseInt(editId), name: n, price: p, recipeIds: rIds, image: currentImg };
        } else {
            DB.products.push({ id: Date.now(), name: n, price: p, recipeIds: rIds, image: currentImg });
        }
        saveData(); cancelEdit(); renderProductsTable(); renderProducts();
    }
    function renderProductsTable() {
        const tb = document.getElementById('productsTable'); tb.innerHTML = '';
        DB.products.forEach(p => {
            tb.innerHTML += `<tr><td>${p.name}</td><td>Q${p.price}</td><td><button onclick="editProd(${p.id})">‚úèÔ∏è</button></td></tr>`;
        });
    }

    function calcStats() {
        let today = getLocalYMD(); document.getElementById('todayDateLabel').innerText = "Hoy: " + today;
        let sT = DB.sales.filter(s => s.dYMD === today);
        let sumS = sT.reduce((a, b) => a + b.t, 0);
        document.getElementById('todayStats').innerText = `Total Ventas Hoy: Q${sumS.toFixed(2)}`;
        
        const cont = document.getElementById('chartContainer'); cont.innerHTML = '';
        let dps = [];
        for (let i = 4; i >= 0; i--) {
            let d = new Date(); d.setDate(d.getDate() - i); let y = getLocalYMD(d);
            let ds = DB.sales.filter(x => x.dYMD === y).reduce((a, b) => a + b.t, 0);
            dps.push({ l: d.toLocaleDateString('es-GT',{weekday:'short'}), s: ds });
        }
        let max = Math.max(...dps.map(x => x.s), 100);
        dps.forEach(d => {
            let sH = (d.s/max)*100;
            cont.innerHTML += `<div style="display:flex; flex-direction:column; align-items:center">
                <div class="bar bar-green" style="height:${Math.max(sH,5)}%"></div>
                <span style="font-size:0.7rem; font-weight:700; margin-top:5px">${d.l}</span></div>`;
        });
    }

    function clearAllData() { if (confirm("‚ö†Ô∏è ¬øBorrar historial?")) { DB.sales = []; DB.expenses = []; saveData(); calcStats(); alert("Borrado"); } }

    function openMenu() { document.getElementById('modalMenu').style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openSection(id) {
        closeModal('modalMenu'); document.getElementById(id).style.display='flex';
        if(id==='modalInventario'){ renderInventoryTable(); renderProductsTable(); updateRecipeChecklist(); }
        if(id==='modalHistorial') calcStats();
    }
    function updateRecipeChecklist() {
        let c = document.getElementById('recipeChecklist'); c.innerHTML = '';
        DB.inventory.forEach(i => { c.innerHTML += `<label style="display:block; padding:8px; border-bottom:0.5px solid #eee"><input type="checkbox" value="${i.id}"> ${i.name}</label>`; });
    }
    function editProd(id) { let p = DB.products.find(x => x.id == id); document.getElementById('editProdId').value = p.id; document.getElementById('prodName').value = p.name; document.getElementById('prodPrice').value = p.price; currentImg = p.image; }
    function cancelEdit() { document.getElementById('editProdId').value = ''; document.getElementById('prodName').value=''; document.getElementById('prodPrice').value=''; currentImg=null; }

    loadData();
</script>
</body>
</html>
