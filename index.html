<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>¬°Se te Antoja! üòã</title>
    <style>
        :root {
            --primary: #FF8C00; --secondary: #FFD700; --accent: #D32F2F;
            --dark: #333; --light: #f4f4f4; --green: #2ecc71; --blue: #3498db;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { background: var(--primary); color: white; padding: 0 15px; display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); height: 70px; }
        .logo { grid-column: 2; font-size: 1.8rem; font-weight: 900; text-align: center; white-space: nowrap; }
        .menu-btn { grid-column: 3; justify-self: end; background: white; color: var(--primary); border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 1rem; }

        .main-container { display: flex; flex: 1; height: calc(100% - 70px); }
        .products-area { flex: 2; padding: 10px; overflow-y: auto; background: #fff5e6; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); grid-auto-rows: 200px; gap: 10px; align-content: start; }
        .product-card { background: white; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s; border: 2px solid transparent; overflow: hidden; position: relative; }
        .product-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px 10px 0 0; margin-bottom: 5px; }
        .prod-name { font-weight: bold; font-size: 0.95rem; color: var(--dark); line-height: 1.1; }
        .prod-price { color: var(--accent); font-weight: bold; font-size: 1.2rem; }

        .cart-area { flex: 1; background: white; display: flex; flex-direction: column; border-left: 1px solid #ddd; padding: 10px; min-width: 320px; }
        .cart-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .del-btn { color: red; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 10px; }
        .totals-area { background: var(--light); padding: 15px; border-radius: 10px; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .payment-input { width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; }
        .change-display { text-align: center; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; color: white; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .btn-pay { background: var(--green); opacity: 0.5; pointer-events: none; }
        .btn-pay.active { opacity: 1; pointer-events: auto; }
        .btn-credit { background: var(--blue); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; flex-direction: column; }
        .modal-header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { padding: 20px; overflow-y: auto; flex: 1; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 20px; }
        .menu-option { background: var(--primary); color: white; padding: 30px; border-radius: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; border:none; }

        .qty-controls { display: flex; align-items: center; gap: 5px; }
        .qty-btn { width: 35px; height: 35px; border-radius: 8px; border: none; font-weight: bold; font-size: 1.4rem; cursor: pointer; display: flex; justify-content: center; align-items: center; color: white; }
        .btn-plus { background: var(--green); } .btn-minus { background: var(--accent); }
        .qty-display { font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center; }

        .chart-container { height: 250px; display: flex; align-items: flex-end; justify-content: space-around; margin-top: 20px; background: #fff; border-bottom: 2px solid #333; padding-bottom: 5px; }
        .bar-group { display: flex; flex-direction: column; align-items: center; width: 25%; }
        .bar { width: 100%; transition: height 0.5s; display: flex; align-items: flex-end; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; border-radius: 4px 4px 0 0; }
        .bar-green { background: var(--green); } .bar-blue { background: var(--blue); } .bar-red { background: var(--accent); }
        .net-indicator { font-size: 1.8rem; margin-top: 10px; text-align: center; font-weight: bold; }

        .recipe-checklist { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: #f9f9f9; }
        .recipe-checklist label { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .recipe-checklist input { margin-right: 15px; transform: scale(1.5); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .split-view { display: flex; height: 100%; gap: 20px; flex-direction: column; }
        @media (min-width: 768px) { .split-view { flex-direction: row; } }
        .split-left, .split-right { flex: 1; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <div></div>
    <div class="logo">¬°Se te Antoja! üòã</div>
    <button class="menu-btn" onclick="openMenu()">MEN√ö ‚ò∞</button>
</header>

<div class="main-container">
    <div class="products-area" id="productsGrid"></div>
    <div class="cart-area">
        <h3>Detalle de Venta</h3>
        <div class="cart-list" id="cartList"></div>
        <div class="totals-area">
            <div class="total-row"><span>Total:</span><span id="totalAmount">Q0.00</span></div>
            <input type="number" id="payInput" class="payment-input" placeholder="¬øCon cu√°nto paga?" oninput="calcChange()">
            <div class="change-display" id="changeDisplay">Cambio: Q0.00</div>
            <button id="btnPay" class="action-btn btn-pay" onclick="processPayment('cash')">COBRAR üíµ</button>
            <button class="action-btn btn-credit" onclick="processPayment('credit')">FIADO üìù</button>
        </div>
    </div>
</div>

<div id="modalMenu" class="modal">
    <div class="modal-header"><span>Men√∫ Principal</span><button class="menu-btn" onclick="closeModal('modalMenu')">Cerrar X</button></div>
    <div class="modal-content menu-grid">
        <button class="menu-option" style="background:#e67e22" onclick="openSection('modalGastos')">GASTOS üí∏</button>
        <button class="menu-option" style="background:#3498db" onclick="openSection('modalFiado')">FIADO üìí</button>
        <button class="menu-option" style="background:#9b59b6" onclick="openSection('modalHistorial')">HISTORIAL üìä</button>
        <button class="menu-option" style="background:#27ae60" onclick="openSection('modalInventario')">INVENTARIO üì¶</button>
    </div>
</div>

<div id="modalInventario" class="modal">
    <div class="modal-header"><span>Inventario</span><button class="menu-btn" onclick="closeModal('modalInventario')">Volver</button></div>
    <div class="modal-content split-view">
        <div class="split-left">
            <h3>Materia Prima</h3>
            <input type="text" id="invName" placeholder="Nombre (Ej: Pan)" style="width:100%; padding:10px">
            <input type="number" id="invQty" placeholder="Cant." style="width:100%; padding:10px; margin-top:5px">
            <button class="action-btn" style="background:var(--dark); margin-top:5px" onclick="addInventoryItem()">Crear Material</button>
            <table id="inventoryTable"><thead><tr><th>Material</th><th>Ajuste</th><th>Borrar</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="split-right">
            <h3>Productos Men√∫</h3>
            <div style="border:2px solid var(--primary); padding:10px; border-radius:10px">
                <h4 id="formTitle">Nuevo Producto</h4>
                <label class="file-upload-btn" onclick="document.getElementById('prodImgInput').click()">üì∑ Foto</label>
                <input type="file" id="prodImgInput" accept="image/*" style="display:none" onchange="previewProdImg(this)">
                <img id="prodImgPreview" style="width:80px; height:80px; object-fit:cover; display:none; margin:5px auto; border-radius:10px">
                <input type="hidden" id="editProdId">
                <input type="text" id="prodName" placeholder="Nombre" style="width:100%; padding:8px">
                <input type="number" id="prodPrice" placeholder="Precio (Q)" style="width:100%; padding:8px; margin-top:5px">
                <div id="recipeChecklist" class="recipe-checklist" style="margin-top:10px"></div>
                <button id="btnSaveProd" class="action-btn" style="background:var(--primary); margin-top:10px" onclick="saveProduct()">Guardar</button>
                <button id="btnCancelEdit" class="action-btn" style="background:grey; display:none" onclick="cancelEdit()">Cancelar</button>
            </div>
            <table id="productsTable"><thead><tr><th>Producto</th><th>Precio</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
</div>

<div id="modalGastos" class="modal">
    <div class="modal-header"><span>Gastos</span><button class="menu-btn" onclick="closeModal('modalGastos')">Volver</button></div>
    <div class="modal-content split-view">
        <div class="split-left">
            <h3>Nuevo Gasto</h3>
            <input type="date" id="expenseDate" style="width:100%; padding:10px">
            <input type="text" id="expenseDesc" placeholder="Descripci√≥n" style="width:100%; padding:10px; margin-top:5px">
            <input type="number" id="expenseAmount" placeholder="Monto (Q)" style="width:100%; padding:10px; margin-top:5px">
            <button class="action-btn" style="background:var(--accent); margin-top:10px" onclick="addExpense()">Registrar</button>
        </div>
        <div class="split-right"><h3>Gastos Hoy</h3><div id="expensesList"></div></div>
    </div>
</div>

<div id="modalFiado" class="modal">
    <div class="modal-header"><span>Fiados</span><button class="menu-btn" onclick="closeModal('modalFiado')">Volver</button></div>
    <div class="modal-content"><table id="creditTable"><thead><tr><th>Fecha</th><th>Cliente</th><th>Q</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table></div>
</div>

<div id="modalHistorial" class="modal">
    <div class="modal-header"><span>Historial</span><button class="menu-btn" onclick="closeModal('modalHistorial')">Volver</button></div>
    <div class="modal-content">
        <div style="display:flex; gap:10px; margin-bottom:15px">
            <button class="menu-btn" style="background:#27ae60; color:white" onclick="exportToExcel()">Excel</button>
            <button class="menu-btn" style="background:black; color:white" onclick="clearAllData()">‚ö†Ô∏è BORRAR TODO</button>
        </div>
        <div class="split-view">
            <div class="split-left">
                <h3 id="todayDateLabel"></h3>
                <div id="todayStats" style="font-size:1.2rem; margin-bottom:15px"></div>
                <div id="salesHistoryList" style="max-height:250px; overflow-y:auto; border:1px solid #ddd"></div>
            </div>
            <div class="split-right">
                <div style="display:flex; justify-content:space-between"><h3>Gr√°fica</h3>
                <div><button onclick="setChartMode('daily')">HOY</button><button onclick="setChartMode('weekly')">SEMANA</button></div></div>
                <div class="chart-container" id="chartContainer"></div>
                <div id="netIndicator" class="net-indicator"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let DB = { products: [], inventory: [], sales: [], expenses: [], credits: [] };
    let cart = []; let currentImg = null; let chartMode = 'daily';

    const getLocalYMD = (d = new Date()) => {
        let off = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - off).toISOString().split('T')[0];
    };

    function loadData() {
        let saved = localStorage.getItem('antojableDB_v4');
        if (saved) DB = JSON.parse(saved);
        else seedData();
        renderProducts();
    }
    function saveData() { localStorage.setItem('antojableDB_v4', JSON.stringify(DB)); }
    function seedData() { DB.inventory = [{id:1, name:'Pan', qty:10}]; saveData(); }

    function renderProducts() {
        const grid = document.getElementById('productsGrid'); grid.innerHTML = '';
        DB.products.forEach(p => {
            const card = document.createElement('div'); card.className = 'product-card';
            card.innerHTML = `${p.image ? `<img src="${p.image}">` : `<div style="height:120px; background:#eee"></div>`}
                <div class="prod-name">${p.name}</div><div class="prod-price">Q${p.price}</div>`;
            card.onclick = () => { cart.push({...p, cId: Date.now()}); renderCart(); };
            grid.appendChild(card);
        });
    }

    function renderCart() {
        const list = document.getElementById('cartList'); list.innerHTML = '';
        let total = 0;
        cart.forEach(i => {
            total += parseFloat(i.price);
            list.innerHTML += `<div class="cart-item"><span>${i.name}</span><span>Q${i.price} <button class="del-btn" onclick="removeItem(${i.cId})">üóëÔ∏è</button></span></div>`;
        });
        document.getElementById('totalAmount').innerText = `Q${total.toFixed(2)}`;
        calcChange();
    }
    function removeItem(id) { cart = cart.filter(i => i.cId !== id); renderCart(); }

    function calcChange() {
        let t = cart.reduce((s, i) => s + parseFloat(i.price), 0);
        let p = parseFloat(document.getElementById('payInput').value) || 0;
        let b = document.getElementById('btnPay');
        if (t > 0 && p >= t) { b.classList.add('active'); document.getElementById('changeDisplay').innerText = `Cambio: Q${(p-t).toFixed(2)}`; }
        else { b.classList.remove('active'); document.getElementById('changeDisplay').innerText = "Falta dinero"; }
    }

    function processPayment(type) {
        let t = cart.reduce((s, i) => s + parseFloat(i.price), 0); if (t === 0) return;
        let now = new Date();
        if (type === 'credit') {
            let n = prompt("Nombre Cliente:"); if (!n) return;
            DB.credits.push({ id: Date.now(), dIso: now.toISOString(), dYMD: getLocalYMD(now), name: n, t: t, items: [...cart] });
        } else {
            cart.forEach(p => { if (p.recipeIds) p.recipeIds.forEach(rid => { let inv = DB.inventory.find(iv => iv.id == rid); if (inv) inv.qty--; })});
            DB.sales.push({ id: Date.now(), dIso: now.toISOString(), dYMD: getLocalYMD(now), t: t });
        }
        saveData(); cart = []; document.getElementById('payInput').value = ''; renderCart(); alert("¬°Listo!");
    }

    function addInventoryItem() {
        let n = document.getElementById('invName').value; let q = parseInt(document.getElementById('invQty').value) || 0;
        if (!n) return; DB.inventory.push({ id: Date.now(), name: n, qty: q });
        saveData(); renderInventoryTable(); updateRecipeChecklist();
    }
    function renderInventoryTable() {
        const tb = document.querySelector('#inventoryTable tbody'); tb.innerHTML = '';
        DB.inventory.forEach(i => {
            tb.innerHTML += `<tr><td>${i.name}</td><td><div class="qty-controls">
                <button class="qty-btn btn-minus" onclick="adjInv(${i.id},-1)">-</button>
                <span class="qty-display">${i.qty}</span>
                <button class="qty-btn btn-plus" onclick="adjInv(${i.id},1)">+</button></div></td>
                <td><button onclick="delInv(${i.id})">‚ùå</button></td></tr>`;
        });
    }
    function adjInv(id, n) { let i = DB.inventory.find(x => x.id == id); if (i) { i.qty += n; if (i.qty < 0) i.qty = 0; saveData(); renderInventoryTable(); } }

    function previewProdImg(f) {
        let r = new FileReader(); r.onload = e => { currentImg = e.target.result; document.getElementById('prodImgPreview').src = currentImg; document.getElementById('prodImgPreview').style.display='block'; };
        r.readAsDataURL(f.files[0]);
    }

    function saveProduct() {
        let n = document.getElementById('prodName').value; let p = parseFloat(document.getElementById('prodPrice').value);
        let rIds = Array.from(document.querySelectorAll('#recipeChecklist input:checked')).map(c => parseInt(c.value));
        if (!n || !p) return;
        let editId = document.getElementById('editProdId').value;
        if (editId) {
            let idx = DB.products.findIndex(x => x.id == editId);
            DB.products[idx] = { id: parseInt(editId), name: n, price: p, recipeIds: rIds, image: currentImg };
        } else {
            DB.products.push({ id: Date.now(), name: n, price: p, recipeIds: rIds, image: currentImg });
        }
        saveData(); cancelEdit(); renderProductsTable(); renderProducts();
    }
    function renderProductsTable() {
        const tb = document.querySelector('#productsTable tbody'); tb.innerHTML = '';
        DB.products.forEach(p => {
            tb.innerHTML += `<tr><td>${p.name}</td><td>Q${p.price}</td><td>
                <button onclick="editProd(${p.id})">‚úèÔ∏è</button><button onclick="delProd(${p.id})">üóëÔ∏è</button></td></tr>`;
        });
    }
    function editProd(id) {
        let p = DB.products.find(x => x.id == id); document.getElementById('editProdId').value = p.id;
        document.getElementById('prodName').value = p.name; document.getElementById('prodPrice').value = p.price;
        document.getElementById('formTitle').innerText = "Editando..."; document.getElementById('btnCancelEdit').style.display = 'block';
        currentImg = p.image; if(p.image) { document.getElementById('prodImgPreview').src = p.image; document.getElementById('prodImgPreview').style.display='block'; }
    }
    function cancelEdit() { document.getElementById('editProdId').value = ''; document.getElementById('formTitle').innerText="Nuevo"; document.getElementById('btnCancelEdit').style.display='none'; document.getElementById('prodName').value=''; document.getElementById('prodPrice').value=''; document.getElementById('prodImgPreview').style.display='none'; currentImg=null; }

    function setChartMode(m) { chartMode = m; calcStats(); }
    function calcStats() {
        let today = getLocalYMD(); document.getElementById('todayDateLabel').innerText = today;
        let sT = DB.sales.filter(s => s.dYMD === today);
        let eT = DB.expenses.filter(e => e.dateYMD === today);
        let sumS = sT.reduce((a, b) => a + b.t, 0);
        let sumE = eT.reduce((a, b) => a + b.amount, 0);
        document.getElementById('todayStats').innerText = `Venta: Q${sumS.toFixed(2)} | Gasto: Q${sumE.toFixed(2)} | Neto: Q${(sumS-sumE).toFixed(2)}`;
        
        const cont = document.getElementById('chartContainer'); cont.innerHTML = '';
        let dps = [];
        if (chartMode === 'daily') dps.push({ l: 'HOY', s: sumS, e: sumE });
        else {
            for (let i = 6; i >= 0; i--) {
                let d = new Date(); d.setDate(d.getDate() - i); let y = getLocalYMD(d);
                let ds = DB.sales.filter(x => x.dYMD === y).reduce((a, b) => a + b.t, 0);
                let de = DB.expenses.filter(x => x.dateYMD === y).reduce((a, b) => a + b.amount, 0);
                dps.push({ l: d.toLocaleDateString('es-GT',{weekday:'short'}), s: ds, e: de });
            }
        }
        let max = Math.max(...dps.map(x => Math.max(x.s, x.e)), 100);
        dps.forEach(d => {
            let sH = (d.s/max)*100; let eH = (d.e/max)*100;
            cont.innerHTML += `<div class="bar-group"><div style="display:flex; height:100%; align-items:flex-end; gap:2px; width:100%">
                <div class="bar bar-green" style="height:${Math.max(sH,2)}%"></div>
                <div class="bar bar-red" style="height:${Math.max(eH,2)}%"></div></div>
                <span style="font-size:0.6rem">${d.l}</span></div>`;
        });
    }

    function clearAllData() {
        if (confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Se borrar√°n todas las VENTAS y GASTOS registrados.")) {
            if (confirm("√öLTIMA ADVERTENCIA: Esta acci√≥n no se puede deshacer. ¬øProceder?")) {
                DB.sales = []; DB.expenses = []; DB.credits = [];
                saveData(); calcStats(); updateExpensesList(); alert("Historial borrado.");
            }
        }
    }

    function addExpense() {
        let d = document.getElementById('expenseDate').value || getLocalYMD();
        let ds = document.getElementById('expenseDesc').value; let a = parseFloat(document.getElementById('expenseAmount').value);
        if(!ds || !a) return; DB.expenses.push({id:Date.now(), dateYMD:d, desc:ds, amount:a});
        saveData(); updateExpensesList(); alert("Gasto ok");
    }
    function updateExpensesList() {
        let h = document.getElementById('expensesList'); h.innerHTML = '';
        DB.expenses.filter(e => e.dateYMD === getLocalYMD()).forEach(e => { h.innerHTML += `<div>Q${e.amount} - ${e.desc}</div>`; });
    }

    function openMenu() { document.getElementById('modalMenu').style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openSection(id) {
        closeModal('modalMenu'); document.getElementById(id).style.display='flex';
        if(id==='modalInventario'){ renderInventoryTable(); renderProductsTable(); updateRecipeChecklist(); cancelEdit(); }
        if(id==='modalHistorial') calcStats();
        if(id==='modalGastos') { document.getElementById('expenseDate').value=getLocalYMD(); updateExpensesList(); }
    }
    function updateRecipeChecklist() {
        let c = document.getElementById('recipeChecklist'); c.innerHTML = '';
        DB.inventory.forEach(i => { c.innerHTML += `<label><input type="checkbox" value="${i.id}"> ${i.name}</label>`; });
    }

    loadData();
</script>
</body>
</html>
